<!DOCTYPE html>
<html lang="en">

<head>
    <title>Nathan Crews Node.js Portfolio</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="styles/styles.css" />
    <script src="https://unpkg.com/htmx.org@2.0.0"
        integrity="sha384-wS5l5IKJBvK6sPTKa2WZ1js3d947pvWXbPJ1OmWfEuxLgeHcEbjUUA5i9V5ZkpCw"
        crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

</head>

<body>
    <div id="map" class="map"></div>

    <script type="text/javascript">

         var droneIcon = L.icon({
            iconUrl: 'images/drone-icon.jpg',
            iconSize: [24, 24],
            iconAnchor: [12, 12],
            popupAnchor: [0, 112]
        });

        async function loadJSONFile(jsonFileURL, map) {
            var imagesMap;
            var fetchJson = await fetch(jsonFileURL);
            if (fetchJson.status === 200) {
                var fetchData = await fetchJson.json();
                if (fetchData) {

                    imagesMap = L.geoJSON(fetchData, {
                        pointToLayer: function (point, latlng) {
                            return L.marker(latlng, { icon: droneIcon });
                        },
                    }).bindPopup(function (layer) {
                        return "<div style='margin:0px; padding:0px;'><p style='z-index: -1;'><b>" + layer.feature.properties.name + "</b></p> \
                        <a href='" + layer.feature.properties.name + "' style='z-index:100;' target='window'><img style='rotate: " +
                            Number(layer.feature.properties.cameraDirection) + "deg; max-width: 325px; max-height:225px;' src='" +
                            layer.feature.properties.thumbFileName + "' /></a></div>";
                    }).addTo(map);
                }
                else {
                    console.log("Parsing GeoJSON file failed: ", jsonFileURL)
                }
            }
            else {
                console.log("Load GeoJSON file failed: ", jsonFileURL)
            }
            return imagesMap;
        }

        async function main() {

            var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap'
            });

            var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 20,
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });

            var map = L.map('map', {
                zoom: 19,
                layers: [osm, Esri_WorldImagery]
            });

            document.getElementById('map').style.height = "80vh";
            document.getElementById('map').style.width = "100%";

            let jsonFileURL = "uploads/nathan/pics/geo-images.json";

            var imagePointLayer = await loadJSONFile(jsonFileURL, map);

            if (imagePointLayer !== undefined) {
                map.fitBounds(imagePointLayer.getBounds());
            }

            var baseMaps = {
                "OpenStreetMap": osm,
                "Esri_WorldImagery": Esri_WorldImagery
            };

            var layerControl = L.control.layers(baseMaps);
            layerControl.addTo(map);
        }

        main();

    </script>
</body>