<!DOCTYPE html>
<html lang="en">

<head>
    <title>Nathan Crews Node.js Portfolio</title>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="styles/styles.css" />
    <link rel="stylesheet" href="styles/drop-zone.css">
    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js'
        data-cf-beacon='{"token": "fa970db8cf1343a78f1e7f5c7b1c4ea8"}'></script>
    <!-- End Cloudflare Web Analytics -->

    <script src="https://unpkg.com/htmx.org@2.0.0"
        integrity="sha384-wS5l5IKJBvK6sPTKa2WZ1js3d947pvWXbPJ1OmWfEuxLgeHcEbjUUA5i9V5ZkpCw"
        crossorigin="anonymous"></script>
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>

<body>
    <header id="loading-headrer" name="loading-headrer" class="loading">
        <h2>Drag & Drop images on Map Below</h2>
        <img id="loading-image" name="loading-image" src="images/loading.gif" class="loading-image" />

    </header>
    <!-- class="drop-zone-map map" -->
    <div id="map" class="drop-zone-map map">
        <form id="uploadForm" method="post" enctype="multipart/form-data" action="cgi-bin/ncupload.exe" target="results"
            hidden="true">
            <input id="maxFilesPerRequest" name="maxFilesPerRequest" hidden="true" value="50" />
            <input id="redirectCGI" name="redirectCGI" hidden="true"
                value="image-geo/image-mapper.js?dir=%s&response_type=json" />
            <input id="fileTypePathMap" name="fileTypePathMap" hidden="true" value="*=.jpg,.png,.JPG,.PNG" />
            <input id="basePathMap" name="basePathMap" hidden="true" value="uploads" />
            <label for="directory">Directory Name:</label>
            <input id="directory" name="directory" value="test_drop" type="text">
            <label for="file">File(s):</label>
            <input id="file" type="file" name="file" class="drop-zone__input" multiple="true"
                accept=".jpg,.png,.JPG,.PNG">
            <button id="submit-button" name="submit-button" type="submit">Upload</button>
        </form>
    </div>
    <script src="src/drop-zone.js"></script>
    <script type="module">import { nc_ChunkFileUploadRequests, nc_IsFileTypeAllowed } from "./src/nc_file_upload_client.js"

        const form = document.getElementById("uploadForm");
        if (form) {
            form.addEventListener("submit", submitClicked);
        }
        
        document.getElementById("loading-image").style.display = "none";

        var map;

        var droneIcon = L.icon({
            iconUrl: 'images/drone-icon.jpg',
            iconSize: [24, 24],
            iconAnchor: [12, 12],
            popupAnchor: [0, 112]
        });

        async function submitClicked(event) {
            if (form) {
                event.preventDefault();

                var filesEl = document.getElementById("file")

                var loadingImageEl = document.getElementById("loading-image")
                var mapDivEl = document.getElementById("map")

                if (loadingImageEl) {
                    //   mapDivEl.style.margin = "0px";
                    loadingImageEl.style.display = "flex";
                }

                var uploadActionResults = await nc_ChunkFileUploadRequests(form, filesEl);

                if (loadingImageEl) {
                    loadingImageEl.style.display = "none";
                }

                var fetchDataJSON;
                if (uploadActionResults && uploadActionResults.length > 10) {
                    try {
                        fetchDataJSON = JSON.parse(uploadActionResults);
                    } catch (error) {
                        // console.log(error);
                        fetchDataJSON = null;
                    }
                }

                if (fetchDataJSON) {
                    var imagesMap;

                    imagesMap = await L.geoJSON(fetchDataJSON, {
                        pointToLayer: function (point, latlng) {
                            return L.marker(latlng, { icon: droneIcon });
                        },
                    }).bindPopup(function (layer) {
                        return "<div style='margin:0px; padding:0px;'><p style='z-index: -1;'><b>" + layer.feature.properties.name + "</b></p> \
                        <a href='" + layer.feature.properties.name + "' style='z-index:100;' target='window'><img style='rotate: " +
                            Number(layer.feature.properties.cameraDirection) + "deg; max-width: 325px; max-height:225px;' src='" +
                            layer.feature.properties.thumbFileName + "' /></a></div>";
                    });

                    if (imagesMap !== undefined) {
                        imagesMap.addTo(map);
                        map.fitBounds(imagesMap.getBounds());
                    }
                }
            }

        }

        async function loadJSONFile(jsonFileURL, map) {
            var imagesMap;
            var fetchJson = await fetch(jsonFileURL);
            if (fetchJson.status === 200) {
                var fetchData = await fetchJson.json();
                if (fetchData) {

                    imagesMap = L.geoJSON(fetchData, {
                        pointToLayer: function (point, latlng) {
                            return L.marker(latlng, { icon: droneIcon });
                        },
                    }).bindPopup(function (layer) {
                        return "<div style='margin:0px; padding:0px;'><p style='z-index: -1;'><b>" + layer.feature.properties.name + "</b></p> \
                        <a href='" + layer.feature.properties.name + "' style='z-index:100;' target='window'><img style='rotate: " +
                            Number(layer.feature.properties.cameraDirection) + "deg; max-width: 325px; max-height:225px;' src='" +
                            layer.feature.properties.thumbFileName + "' /></a></div>";
                    }).addTo(map);
                }
                else {
                    console.log("Parsing GeoJSON file failed: ", jsonFileURL)
                }
            }
            else {
                console.log("Load GeoJSON file failed: ", jsonFileURL)
            }
            return imagesMap;
        }

        async function main() {

            var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            });

            var Esri_Imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 20,
            });

            map = L.map('map', {
                center: [56.01877997222222, -3.7548339722222224],
                zoom: 14,
                layers: [osm, Esri_Imagery]
            });

            // document.getElementById('map').style.height = "80vh";
            // document.getElementById('map').style.width = "100%";

            let jsonFileURL = "uploads/test_drop/geo-images.json";

            // var imagePointLayer = await loadJSONFile(jsonFileURL, map);

            // if (imagePointLayer !== undefined) {
            //     map.fitBounds(imagePointLayer.getBounds());
            // }

            var baseMaps = {
                "Street Map": osm,
                "Esri Imagery": Esri_Imagery
            };

            var layerControl = L.control.layers(baseMaps);
            layerControl.addTo(map);
        }

        main();

    </script>
</body>


<!-- async function ThrottleFileUploads(fileInputEl, formEl) {
    var action = formEl.getAttribute("action");
    var target = formEl.getAttribute("target");
    var doAction = false;

    if (action) {

        var formData = new FormData(formEl);
        var filesArray = [];
        var redirectCGIKey = "redirectCGI";
        var redirectCGIValue = formData.get(redirectCGIKey);

        console.log(redirectCGIValue);

        var maxFilesPerRequest = Number(formData.get("maxFilesPerRequest"));

        if (maxFilesPerRequest == 0) {
            maxFilesPerRequest = 50;
        }

        for ([key, value] of formData.entries()) {
            if (value instanceof File) {
                filesArray.push(value);
            }
        }

        var maxRequestCount = Math.ceil(filesArray.length / maxFilesPerRequest);
        var requestCount = 1;

        //console.log("maxRequest number : ", maxRequestCount);

        if (maxRequestCount > 1) {
            formData.delete(redirectCGIKey)
        }

        for (var ii = 0; ii < (filesArray.length); ii += maxFilesPerRequest) {

            for ([key, value] of formData.entries()) {
                if (value instanceof File) {
                    formData.delete(key)
                }
            }

            for (var yy = 0; yy < (maxFilesPerRequest); yy++) {
                //console.log('ii= ', ii, ' yy= ', yy);

                if (ii + yy < filesArray.length) {
                    //console.log('adding file : ', filesArray[ii + yy].name);
                    formData.append("file", filesArray[ii + yy])
                }
            }

            if (requestCount == maxRequestCount) {
                doAction = true;
                formData.append(redirectCGIKey, redirectCGIValue)
            }

            //console.log("sending request # ", requestCount, " of ", maxRequestCount);

            var response = await fetch(action, {
                method: "POST",
                body: formData
            }).catch(error => { console.log(error); });

            var imagesMap;

            if (doAction && response.status >= 200 && response.status < 300) {
                var fetchData = "";
                var fetchDataJSON;

                try {
                    fetchData = await response.text();
                } catch (error) {
                    console.log(error);
                    fetchData = "";
                }

                if (fetchData && fetchData.length > 10) {
                    //console.log("fetchData=", fetchData);
                    try {
                        fetchDataJSON = JSON.parse(fetchData);
                    } catch (error) {
                        // console.log(error);
                        fetchDataJSON = null;
                    }
                }

                if (fetchDataJSON) {

                    imagesMap = await L.geoJSON(fetchDataJSON, {
                        pointToLayer: function (point, latlng) {
                            return L.marker(latlng, { icon: droneIcon });
                        },
                    }).bindPopup(function (layer) {
                        return "<div style='margin:0px; padding:0px;'><p style='z-index: -1;'><b>" + layer.feature.properties.name + "</b></p> \
                <a href='" + layer.feature.properties.name + "' style='z-index:100;' target='window'><img style='rotate: " +
                            Number(layer.feature.properties.cameraDirection) + "deg; max-width: 325px; max-height:225px;' src='" +
                            layer.feature.properties.thumbFileName + "' /></a></div>";
                    });

                    imagesMap.addTo(map);

                    if (imagesMap !== undefined) {
                        map.fitBounds(imagesMap.getBounds());
                    }
                }
            }

            requestCount++;
        }
    }
} -->