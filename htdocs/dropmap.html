<!DOCTYPE html>
<html lang="en">

<head>
    <title>Nathan Crews Node.js Portfolio</title>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <script src="https://unpkg.com/htmx.org@2.0.0"
        integrity="sha384-wS5l5IKJBvK6sPTKa2WZ1js3d947pvWXbPJ1OmWfEuxLgeHcEbjUUA5i9V5ZkpCw"
        crossorigin="anonymous"></script>
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="styles/drop-zone.css">
    <link rel="stylesheet" href="styles/nc-map.css" />
</head>

<body class="map-body">
    <header id="loading-header" name="loading-header" class="map-loading">
        <h2 class="map-h2">Drag & Drop images on Map Below</h2>
        <form id="uploadForm" method="post" enctype="multipart/form-data" action="cgi-bin/ncupload.exe" target="results"
            class="map-form-input">
            <label for="directory">Enter Upload Directory Name:</label>
            <input id="directory" name="directory" value="test_drop" type="text" class="map-form-input-text">
            <label for="file" hidden="true">File(s):</label>
            <input id="file" type="file" name="file" class="drop-zone__input" multiple="true"
                accept=".jpg,.png,.JPG,.PNG" hidden="true">
            <button id="submit-button" name="submit-button" type="submit" hidden="true">Upload</button>
            <input id="maxFilesPerRequest" name="maxFilesPerRequest" hidden="true" value="50" />
            <input id="redirectCGI" name="redirectCGI" hidden="true"
                value="image-geo/image-mapper.js?dir=%s&response_type=json" />
            <input id="fileTypePathMap" name="fileTypePathMap" hidden="true" value="*=.jpg,.png,.JPG,.PNG" />
            <input id="basePathMap" name="basePathMap" hidden="true" value="uploads" />
        </form>
        <img id="loading-image" name="loading-image" src="images/loading.gif" class="map-form-loading-image" />
    </header>
    <div id="map" class="map-drop-zone map-base">
    </div>
    <script src="./src/drop-zone.js"></script>
    <script type="module">import { nc_ChunkFileUploadRequests, nc_IsFileTypeAllowed } from "./src/nc_file_upload_client.js"
        //************************************
        // Define Application Data
        //************************************
        let AppUIData = {
            formEl: document.getElementById("uploadForm"),
            dirInputEl: document.getElementById("directory"),
            loadingImageEl: document.getElementById("loading-image")
        }

        let AppMapData = {
            map: null,
            imagesLayer: null,
            layerControl: null,
            imageLayerGroup: null,
            droneIcon: L.icon({
                iconUrl: 'images/drone-icon.jpg',
                iconSize: [24, 24],
                iconAnchor: [12, 12],
                popupAnchor: [0, 95]
            })
        }

        //************************************
        // Define Application Methods
        //************************************
        async function OnDirChanged(event) {
            console.log("clearing image layer")

            if (AppUIData.loadingImageEl) {
                AppUIData.loadingImageEl.style.display = "flex";
            }

            if (AppMapData.imagesLayer) {
                AppMapData.imageLayerGroup.removeLayer(imagesLayer);
                AppMapData.map.removeLayer(imagesLayer);
                AppMapData.imagesLayer = null;
            }
            let newDirectory = event.target.value;
            let formAction = "cgi-bin/image-geo/image-mapper.js?dir=uploads/" + newDirectory + "/&response_type=json";

            // console.log("formAction = ", formAction);

            var response = await fetch(formAction, { method: "GET" }).catch(error => {
                console.log("Error: refresh image GeoJSON failed.", error);
            });

            //console.log("response.status=", response.status)

            if (response.status == 200) {
                var responseText = "ERROR";
                responseText = await response.text();

                let stat = responseText.indexOf("ERROR");
                if (stat < 0) {
                    await UpdateMap(responseText)
                }
            }

            if (AppUIData.loadingImageEl) {
                AppUIData.loadingImageEl.style.display = "none";
            }
        }

        async function SubmitClicked(event) {

            if (AppUIData.formEl) {
                event.preventDefault();

                var filesEl = document.getElementById("file")
                var mapDivEl = document.getElementById("map")

                if (AppUIData.loadingImageEl) {
                    AppUIData.loadingImageEl.style.display = "flex";
                }

                const uploadActionResults = await nc_ChunkFileUploadRequests(AppUIData.formEl, filesEl);

                if (await UpdateMap(uploadActionResults)) {

                    if (AppUIData.loadingImageEl) {
                        AppUIData.loadingImageEl.style.display = "none";
                    }

                    let newFileInputEl = document.createElement("input");
                    if (newFileInputEl) {
                        newFileInputEl.setAttribute('type', 'file');
                        newFileInputEl.setAttribute('id', 'file');
                        newFileInputEl.setAttribute('name', 'file');
                        newFileInputEl.setAttribute('class', 'drop-zone__input');
                        newFileInputEl.setAttribute('multiple', 'true');
                        newFileInputEl.setAttribute('accept', '.jpg,.png,.JPG,.PNG');
                        newFileInputEl.setAttribute('hidden', 'true');

                        AppUIData.formEl.replaceChild(newFileInputEl, filesEl);
                    }
                }
            }
        }

        async function UpdateMap(geoJSONResults) {

            let fetchDataJSON;
            let retVal = false;

            if (geoJSONResults) {
                try {
                    fetchDataJSON = JSON.parse(geoJSONResults);
                    // console.log(fetchDataJSON);
                } catch (error) {
                    console.log(error);
                    return retVal;
                }
            }

            if (fetchDataJSON) {

                if (AppUIData.imagesLayer) {
                    AppUIData.imageLayerGroup.removeLayer(AppUIData.imagesLayer);
                    AppUIData.map.removeLayer(AppUIData.imagesLayer);
                    AppUIData.imagesLayer = null;
                }

                AppUIData.imagesLayer = L.geoJSON(fetchDataJSON, {
                    pointToLayer: function (point, latlng) {
                        // console.log("point = ", point)
                        // console.log("point.properties.thumbFileName = ", point.properties.thumbFileName)

                        let currentDroneIcon = AppMapData.droneIcon;

                        // if (point.properties.thumbFileName) {
                        //     currentDroneIcon = L.icon({
                        //         iconUrl: point.properties.thumbFileName,
                        //         iconSize: [48, 48],
                        //         iconAnchor: [24, 24],
                        //         popupAnchor: [0, 112]
                        //     });
                        // }

                        return L.marker(latlng, { icon: currentDroneIcon });
                    },
                }).bindPopup(function (layer) {
                    return "<div style='width:max-contents;margin:0px; padding:0px;'><p><b>" + layer.feature.properties.name + "</b></p> \
        <a href='" + layer.feature.properties.URLName + "' target='window'><img style=max-width: 250px; max-height:300px;' src='" +
                        layer.feature.properties.thumbFileName + "' /></a></div>";
                });

                if (AppUIData.imagesLayer) {
                    AppUIData.imageLayerGroup.addLayer(AppUIData.imagesLayer);
                    AppUIData.map.fitBounds(AppUIData.imagesLayer.getBounds());
                    retVal = true;
                }
            }

            return retVal;
        }

        async function Main() {

            var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            });

            var Esri_Imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 20,
            });

            AppUIData.map = L.map('map', {
                center: [56.01877997222222, -3.7548339722222224],
                zoom: 14,
                maxZoom: 19,
                layers: [osm, Esri_Imagery]
            });

            var baseMaps = {
                "Street Map": osm,
                "Esri Imagery": Esri_Imagery
            };

            AppUIData.imageLayerGroup = L.layerGroup().addTo(AppUIData.map); // Create empty photos LayerGroup
            AppUIData.layerControl = L.control.layers(baseMaps);
            AppUIData.layerControl.addOverlay(AppUIData.imageLayerGroup, "Uploaded Pics");  // Add empty photos group to layer control
            AppUIData.layerControl.addTo(AppUIData.map);
        }

        async function LoadGeoJSONFile(jsonFileURL, map) {
            var imagesMap;
            var fetchJson = await fetch(jsonFileURL);
            if (fetchJson.status === 200) {
                var fetchData = await fetchJson.json();
                if (fetchData) {

                    imagesMap = L.geoJSON(fetchData, {
                        pointToLayer: function (point, latlng) {
                            return L.marker(latlng, { icon: AppMapData.droneIcon });
                        },
                    }).bindPopup(function (layer) {
                        return "<div style='margin:0px; padding:0px;'><span><b>" + layer.feature.properties.name + "</b></span> \
                        <a href='" + layer.feature.properties.URLName + "'target='window'><img style='max-width: 325px; max-height:225px;' src='" +
                            layer.feature.properties.thumbFileName + "'/></a></div>";
                    }).addTo(AppMapData.map);
                }
                else {
                    console.log("Parsing GeoJSON file failed: ", jsonFileURL)
                }
            }
            else {
                console.log("Load GeoJSON file failed: ", jsonFileURL)
            }
            return imagesMap;
        }

        //************************************
        // Attach event listeners
        //************************************

        if (AppUIData.formEl) {
            AppUIData.formEl.addEventListener("submit", SubmitClicked);
        }

        if (AppUIData.dirInputEl) {
            AppUIData.dirInputEl.addEventListener("change", OnDirChanged);
        }

        if (AppUIData.loadingImageEl) {
            AppUIData.loadingImageEl.style.display = "none";
        }

        //************************************
        // Run Application
        //************************************
        Main();

    </script>
</body>